<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure chat</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <style>
        .hidden {
            display: none;
        }
    </style>

    <script type="text/javascript">
      secure_chat_client = null;

      navigator.webkitPersistentStorage.requestQuota(5 * 1024 * 1024,
      function(bytes) {
        $('#log').append('<b>info:</b>Allocated ' + bytes + ' bytes of persistant storage.<br>');
      },
      function(e) { alert('Failed to allocate space') });

      function moduleDidLoad() {
         secure_chat_client = document.getElementById('secure_chat_client');
          $('#log').append('<b>info:</b>PNACL themis module loaded<br>');
      }

      function handleMessage(message_event) {
         msg=message_event.data;
         command=msg[0];
         args=msg.slice(1);
         if (command == "available_chat_list")
         {
             var arr = msg[1].split(' ');
             show_chat_list();
             for(var i = 0; i < arr.length; i++){
		add_room_to_list(arr[i],arr[i])	 
             }
         }
         else if (command == "new_room")
         {
             open_chat(msg[1]);
         }
         else if (command == "open_room")
         {
		show_chat();
         }
         else if (command == "invite")
	 {
		show_generated_invite(args);
         }
         else if (command == "new_message")
	{
		add_message(args);		
         }
         else
         {
             $('#log').append('<b>'+command+':</b>'+args+'<br>');
         }
      }


    </script>
</head>
<body>
  <div id="listener">
    <script type="text/javascript">
      var listener = document.getElementById('listener');
      listener.addEventListener('message', handleMessage, true);
      listener.addEventListener('load', moduleDidLoad, true);
    </script>
    <embed name="nacl_module"
	   id="secure_chat_client"
	   width=0 height=0
	   src="secure_chat.nmf"
	   url="ws://10.10.1.74:8888/ws"
	   server_pub="VUVDMgAAAC2IRalnA7mIDaKlK5HvBz2woET8cc2dJQ3sOQMYQ/13TtUNofnQ"
	   type="application/x-pnacl" />
  </div>


  <div class="container-fluid">

    <div id='wait_block' class='hidden'>
      <h1>WAIT...</h1>
    </div>
    <div id="login_block" class="hidden">
        <div class="row">
            <input type="text" placeholder="login" name="login" id="login">
        </div>
        <div class="row">
            <input type="text" placeholder="password" name="password" id="password">
        </div>

        <button id="login_ok">Ok</button>
    </div>

    <script type="application/javascript">
        var is_chrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;
        if(is_chrome){
            document.getElementById('login_block').className = '';
        } else {
            document.write('Chat only works in Chrome');
        }
    </script>

    <div id="chat_list_block" class="hidden">
        <div class="row">
            Select chat room:
            <ul id="chat_list">

            </ul>
        </div>
        <div class="row">
            <button id="create_new_room">Create new room</button>
        </div>
        <div class="row">
            <input type="text" name="invite" placeholder="paste invite" id="invite_to_approve">
            <button id="approve">Join</button>
        </div>
    </div>

    <div id="chat" class="hidden">
        <div id="messages" class="row">

        </div>
        <div class="row" style="margin-top: 2em;">
            <button id="generate_invite">Generate invite</button>
        </div>
        <div class="row hidden" id="generated_invite_block">
            <input type="text" name="generated_invite" id="generated_invite" readonly="readonly">
            <a href="javascript:;" id="hide_invite">Hide</a>
        </div>

        <div class="row">
            <input type="text" id="new_message" placeholder="send message" style="float: left;">
            <button id="send_message">Send</button>
        </div>

        <div style="clear:both;"></div>

    </div>
</div>

  <div id="log" class="row" style="margin-top: 2em;">

  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js" type="application/javascript"></script>
    <!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script>
    var LOGIN = null;

    ///////
    // events
    ///////
    function on_login(login, password){
        secure_chat_client.postMessage("login "+login+" "+password);
        show_wait();
    }

    function on_create_new_room(){
        secure_chat_client.postMessage("create_new_room");
        show_wait();
    }
    
    function on_room_select(chat_name, chat_url){
        open_chat(chat_name);
    }

    function on_send_message(message){
        secure_chat_client.postMessage('message <b>'+LOGIN+':</b> '+message);
        add_message('<b>'+LOGIN+':</b> '+message);
    }

    function on_approve(invite){
        secure_chat_client.postMessage("join_by_invite "+invite);
        show_wait();
    }

    function on_generate_invite(){
        secure_chat_client.postMessage("generate_invite");
        //show_generated_invite('asda');
    }

    function open_chat(chat_name){
         secure_chat_client.postMessage("open_room "+chat_name);
    }
    ////////
    // API
    //
    function add_message(message){
        // add message to chat
        $('#messages').append(message+'<br>');
    }

    function add_log(message){
        // add log to log block
        $('#log').append('<p>'+message+'</p>');
    }

    function add_room_to_list(room_name, room_url){
        // add chat item to chat list
        $('#chat_list').append('<li><a class="chat_room" data-url="'+room_url+'" href="javascript:;">' + room_name + '</a>')
    }

    function show_wait(){
        // hide login block and show chat list block
        $('#login_block').addClass('hidden');
        $('#chat_list_block').addClass('hidden');
        $('#chat_block').addClass('hidden');    
        $('#wait_block').removeClass('hidden');
    }

    function show_chat_list(){
        // hide login block and show chat list block
        $('#wait_block').addClass('hidden');
        $('#login_block').addClass('hidden');
        $('#chat_list_block').removeClass('hidden');
    }

    function show_chat(){
        // hide chat list block and show chat block
        $('#wait_block').addClass('hidden');
        $('#chat_list_block').addClass('hidden');
        $('#chat').removeClass('hidden');
    }

    function show_generated_invite(invite){
    // set generated invite and show him
        $('#generated_invite').val(invite);
        $('#generated_invite_block').removeClass('hidden');
    }
    ////////

    $('#login_ok').on('click', function(){
        var login = document.getElementById('login').value;
        var password = document.getElementById('password').value;
        LOGIN = login;
        on_login(login, password);
    })


    $('#chat_list').on('click', '.chat_room', function(){
        var chat_name = $(this).text().trim();
        var chat_url = $(this).data('url');
        on_room_select(chat_name, chat_url);
    });

    $('#send_message').on('click', function(){
        var message = $('#new_message').val();
        on_send_message(message);
    });

    $('#create_new_room').on('click', function(){
        on_create_new_room();
    })

    $('#approve').on('click', function(){
        var invite = $('#invite_to_approve').val();
        on_approve(invite);
    })
    
    $('#generate_invite').on('click', function(){
        on_generate_invite();
    })

    $('#hide_invite').on('click', function(){
        $('#generated_invite_block').addClass('hidden');
    })
</script>

</body>
</html>
