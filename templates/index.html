<!DOCTYPE html>
<html><head><meta charset="UTF-8"/>

	<title>Secure Chat</title>

	<meta name="keywords" content="secure chat"/>
	<meta name="description" content="Just secure chat"/>
	<meta name="author" content="__,,,^._.^,,,__"/>

	<meta name="viewport" content="width=device-width,initial-scale=1"/>

</head><body class="stage1">


<style>

	*				{
					 margin:0;
					 padding:0;
					 border:none;
					 outline:none;
					 background:transparent;
					}

	html,
	body				{width:100%; height:100%; position:absolute; overflow:hidden; background:#eee;}

	body,
	input,
	button,
	textarea			{font-size:16px; font-family:Arial, helvetica; fline-height:1.1em; }

	input,
	button				{width:100%; padding:0.65em 0.5em 0.55em 0.5em; background:#fff; border:1px #abc solid; box-sizing:border-box;}

	p				{margin:1em 0;}

	.auth				{position:absolute; width:100%; height:100%; background:#abc; top:0; visibility:hidden;}
	.auth form			{width:100%; max-width:24em; height:100%; max-height:14em; background:#b1c3d5; top:0; right:0; bottom:0; left:0; margin:auto; position:absolute; box-sizing:border-box; padding:1.5em 2em;}
	.auth form button		{width:80%; margin:1.5em auto 0 auto; display:block; background:royalblue; color:#fff; padding:0.65em 0 0.55em 0; cursor:pointer;}




	.rooms				{position:absolute; overflow-y:scroll; width:100%; background:#b6c8db; top:0; left:0; right:0; bottom:0; visibility:hidden;}
	.rooms .pad			{width:100%;}
	.rooms p			{width:100%; max-width:24em; height:100%; height:4em; margin:1px auto 0 auto; background:#cbe1f5;}



	iframe				{position:absolute; width:100%; height:100%;}
	.chat				{position:absolute; width:100%; height:100%; background:#aea; ftop:-30%; visibility:hidden;}
	.chat .iframe			{position:absolute; bottom:6em; top:0; left:0; right:16em;}
	.chat .input			{position:absolute; height:6em; bottom:0; left:0; right:16em; background:#aab; padding:0 1em; box-sizing:border-box;}
	.chat .users			{position:absolute; height:100%; width:16em; right:0; overflow-y:auto; background:#e2e4e8; }

	.users p			{background:#fff; margin:2px 0 2px 0.5em; padding:1em 0.5em; font-size:0.8em;}


	.chat .input input		{border:2px #89f solid; margin:0.5em auto; padding-right:6em; box-sizing:border-box;}
	.chat .input button		{border:2px #89f solid; border-left:1px #aaa solid; width:6em; background:#eee; position:absolute; top:0.5em; right:1em; }




.stage1	.auth				{visibility:visible;}
.stage2 .rooms				{visibility:visible; opacity:1;}
.stage3 .chat				{visibility:visible;}


	.auth,
	.auth form			{transition:top ease-out 0.2s, opacity ease-out 0.2s;}
.stage1.loading .auth			{top:-7em;}
.stage1.loading .auth form		{top:-20em; opacity:0; fvisibility:hidden;}

	.rooms				{opacity:1; left:0; transition:left ease-out 0.3s, bottom ease-out 0.3s, background ease-out 0.3s;}
.stage1.loading .rooms			{bottom:7em; background:#abc;}

 	.rooms .pad			{opacity:1; margin:2em 0 0 0; transition:opacity ease-out 0.3s, margin ease-out 0.3s}
.stage1.loading .rooms .pad		{opacity:0; margin:4em 0 0 0; }




.stage2 .chat				{visibility:visible;}
.stage2 .chat				{left:100%; opacity:0.5; transition:left ease-out 0.3s, opacity ease-out 0.3s;}
.stage2.stage3 .rooms .pad		{margin:2em 0 0 -5em;}
.stage2.stage3 .chat			{left:0; opacity:1;}


.loaded .auth				{opacity:1; z-index:1000; top:0; left:-50%; visibility:hidden;}
.loaded .auth form			{transition:none;}
.loaded .auth				{transition:left ease-out 0.3s;}

.unload .auth				{left:0; visibility:visible;}


	.log				{position:absolute; width:100%; padding:1em; top:-14em; left:0; right:0; height:12em; border-bottom:10px #531 solid;}
	.log				{background:#000; color:#5c7; font-family:monospace; font-size:12px; line-height:1.5em;}
	.log:hover			{top:0;}


</style>











<style>




	.ani				{width:160px; height:3em; margin-left:-50px; bottom:0; left:50%; position:absolute}
	.ani				{text-align: center;}

	.ani b				{width:1em; height:1em; margin:0 0.75em; background:#abc; border-radius:100%; display: inline-block; -webkit-animation:ani-bounce 1.4s infinite ease-in-out both; animation:ani-bounce 1.4s infinite ease-in-out both;}
	.ani .s1			{-webkit-animation-delay: -0.32s; animation-delay: -0.32s}
	.ani .s2			{-webkit-animation-delay: -0.16s; animation-delay:-0.16s}

@-webkit-keyframes ani-bounce {
	0%,80%,100%			{-webkit-transform:scale(0)}
	40%				{-webkit-transform:scale(1)}
}

@keyframes ani-bounce {
	0%, 80%, 100%			{transform:scale(0)}
	40%				{transform:scale(1)}
}

	.ani				{visibility:hidden; transition:height ease-out 0.3s}
.loading .ani				{height:4em; visibility:visible;}

</style>


<div class="ani"><b class="s1"></b><b class="s2"></b><b class="s3"></b></div>

<div class="auth">

	<form id="auth">
		<p><input type="text" placeholder="Your email as authname"/></p>
		<p><input type="password" placeholder="Your password"/></p>
		<p><button type="submit">Login</button></p>
	</form>

</div>





<div class="rooms" id="rooms"><div class="pad">

	<p><a href="#" id="btn-room-add">Add new room</a></p>


	<form id="newroom">
		<!-- p><input type="text" placeholder="paste invite"/></p -->
		<p><button type="submit">Add new room</button></p>
	</form>

	<form id="invite">
		<p><input type="text" placeholder="paste invite"/></p>
		<p><button type="submit">Join</button></p>
	</form>



</div></div>



<div class="chat">

	<div id="iframe" class="iframe"></div>
	<div class="input"><form id="chatinput">

		<input type="text"/>
		<button type="submit">Say!</button>

	</form></div>
	<div class="users">

		<p><a href="">user1</a></p>
		<p><a href="">user2</a></p>
		<p><a href="">user3</a></p>


	<!-- form id="generate-invite">
		<p><input type="text" placeholder="paste invite"/></p>
		<p><button type="submit">Join</button></p>
	</form -->
        <div class="row" style="margin-top: 2em;">
            <button id="generate_invite" onclick="_client.postMessage('generate_invite');return false;">Generate invite</button>
        </div>
        <div class="row hidden" id="generated_invite_block">
            <input type="text" name="generated_invite" id="generated_invite" readonly="readonly">
            <a href="javascript:;" id="hide_invite">Hide</a>
        </div>


	</div>

</div>






























<style>

		.demo		{position:absolute; width:50%; bottom:0; left:50%; padding:1.5em; background:#000; font-size:11px; font-weight:bold; z-index:10000;}
		.demo a		{padding:0 1em;}

		.d1,
		.d3,
		.d4,
		.d5,
		.d6		{display:none;}

.loading	.d1,
.loading	.d3		{display:inline;}
.loading	.d2		{display:none}

.stage2		.d4,
.stage2		.d5		{display:inline;}
.stage2		.d2		{display:none;}


.stage3		.d4		{display:none;}
.stage3		.d3		{display:inline;}

.unload		.d1,
.unload		.d2,
.unload		.d3,
.unload		.d4,
.unload		.d5		{display:none;}
.unload		.d6		{display:inline;}

</style>

<div class="demo">

	<span style="color:#eee">DEMO:</span>
	<a class="d1" href="#" style="color:#fc0" onclick="_body().className='stage1'; return false;">Back to login if auth fails...</a>
	<a class="d2"  href="#" style="color:#fc0" onclick="_body().classPerk('loading'); return false;">...checking login...</a>

	<a class="d5"  href="#" style="color:#fc0" onclick="_body().classPerk('unload'); return false;">Logout</a>
	<a class="d6"  href="#" style="color:#fc0" onclick="_body().className='stage1'; return false;">Reset</a>

	<a class="d3"  href="#" style="color:#fc0" onclick="_body().classPerk('stage2 loaded', 'stage1 stage3 loading'); return false;">Show rooms</a>
	<a class="d4"  href="#" style="color:#fc0" onclick="_body().classPerk('stage3'); return false;">Chat</a>

</div>



































































<script>

	/* global shortcuts */

	function $( o ) {

		return document.getElementById( o );
	}

	function _tags( t, o ) {

		return (o || document).getElementsByTagName( t );
	}

	function _node( n ) {

		return document.createElement( n );
	}


	function _txt( n ) {

		return document.createTextNode( n );
	}


	function _body() {

		return document.getElementsByTagName('body')[0];
	}


	function _now() {

		var
		t = new Date();

		return (pad(t.getHours(), 2)
		+ ':' + pad(t.getMinutes(), 2)
		+ ':' + pad(t.getSeconds(), 2));
	}


	function pad( n, s ) {

		return (1e15 + n + "").slice( -s );
	}



	var
	chat,
	USER,
	iframe,
	SYSLOG,
	_client,
	_command = {

		 available_chat_list : function( m ) {

			alert( m );
			var arr = m[1].split(' ');
			//     show_chat_list();
			_body().classPerk('stage2 loaded', 'stage1 stage3 loading');



			var rooms = $('rooms').childNodes[0];

			for(var i = 0; i < arr.length; i++){


				var
				p = _node('p'),
				a = _node('a'),
				t = _txt( arr[i] );

				p.id=arr[i];
				a.href = "#";
				a.onclick = function() {

				    _client.postMessage('open_room ' + this.innerHTML );
				    return false;
				}


				a.appendChild(t);
				p.appendChild(a);
				rooms.appendChild(p);
	             	}
		}

		,new_room : function( m ) {

			_client.postMessage('open_room ' + m[1]);
		}

		,open_room : function() {

			_body().classPerk('stage3');
		}

		,invite : function( m ) {

			$('generated_invite').value = m.slice(1);
		}

		,new_message : function( m ) {

			_chatSay( m.slice(1) );
		}

		,remove_room : function( m ) {

			var
			r = $( m.slice(1) );
			r.parentNode.removeChild( r );
		}
	};


	HTMLElement.prototype.classPerk = function(t,e){function s(t,e){for(var s=[],n={},r=t.length-1;r>-1;)!!t[r]&&!(e==t[r])&&!n[t[r]]&&s.unshift(t[r]),n[t[r--]]=1;return s}var t=t.split(" "),e=e||0,n=this.className.split(" ");if(0==e)n=s(n.concat(t));else if(-1==e)for(var r=t.length-1;r>-1;)n=s(n,t[r--]);else if(1==e)for(var r=t.length-1;r>-1;){var i=t[r--];n.indexOf(i)>-1?n=s(n,i):n.push(i)}else{e=e.split(" ");for(var r=e.length-1;r>-1;)n=s(n,e[r--]);n=s(n.concat(t))}this.className=n.join(" ");return this};


	iframe		= $('iframe')
			. appendChild(  _node('iframe') );

			iframe.contentWindow.document.open();
			iframe.contentWindow.document.write('<body></body>');
			iframe.contentWindow.document.close();


	chat		= iframe.contentWindow.document.getElementsByTagName('body')[0];

	chat.content	= chat.appendChild( _node('div') );


	chat.parentNode
			.appendChild( _node('head') )
			.appendChild( _node('style') )
			.appendChild( _txt(

			  '*		{margin:0; padding:0;}'
			+ 'body		{font-size:14px; font-family:Arial, helvetica; background:#fff}'
			+ 'p		{padding:0.75em 1em; border:1px #fff solid; line-height:1.4em}'

			+ '.me		{background:#e5e7f0; margin:0 1.5em 0 20%}'
			+ '.me span	{display:block; color:#7a9; font-size:0.7em; margin:0.5em 0 -0.5em 0; font-family:monospace}'

			+ '.other	{background:#eee; margin-right:20%}'
			+ '.other span	{display:block; color:#7a9; font-size:0.85em; margin:0.5em 0 -0.5em 0; font-family:monospace}'

			));


	navigator.webkitPersistentStorage.requestQuota(5 * 1024 * 1024,
		 function( b ) {

			_log('info: Allocated ' + b + ' bytes of persistant storage');
		 }
		,function( e ) {
			_log('Failed to allocate space');
		}
	);


	/* nacl_module */

	_client = _node('embed');
	_client.setAttribute('type',		'application/x-pnacl');
	_client.setAttribute('name',		'nacl_module');
	_client.setAttribute('src',		'{{ static_resolver(filename="secure_chat.nmf") }}');
	_client.setAttribute('url',		'{{ url }}');
	_client.setAttribute('server_pub',	'{{ server_public_key }}');

	_body().appendChild( _node('div') ).appendChild( _client );

	_client.parentNode.className = 'listener';

	_client.addEventListener('load', moduleLoaded, true);
	_client.addEventListener('message', handleMessage, true);


	function moduleLoaded() {

		_log('info: PNACL themis module loaded');
	}


	function handleMessage( m ) {

		var
		m	= m.data,
		cmd	= m[0],
		args	= m.slice(1);

		if (_command[ cmd ]) {

			_command[ cmd ]( m );
			return false;
		}

		_log( cmd + ': ' + args );
	}



	/* forms and buttons */

	$('auth').onsubmit = function() {

		var
		i = _tags('input', this),
		l = i[0].value,
		p = i[1].value;

		USER = l;

		_client.postMessage('login ' + l + ' ' + p);

		_body().className='stage1 loading';

		return false;
	};


	$('newroom').onsubmit = function() {

		_client.postMessage('create_new_room');

		return false;
	};


	$('invite').onsubmit = function() {

		var
		i = _tags('input', this)[0];

		_client.postMessage('join_by_invite ' + i.value );

		return false;
	};


	$('chatinput').onsubmit = function() {

		var
		m,
		i = _tags('input', this)[0];

		if (i.value) {

			m = _now() + ' ' + USER + ':: ' + i.value;
			_client.postMessage('message ' + m );
			_chatSay( m );
		}

		i.value = '';
		i.focus();
		m = null;

		return false;
	};


	function _chatSay( a ) {

		if (!a) return false;
	
		var
		m = String(a).split('::'),
		f = m[0].split(' '),
		t = f[0], /* time */
		n = f[1], /* name */

		p = _node('p');
		p.className  = ( USER == n ) ? 'me' : 'other';

		p.appendChild( _txt( m[1] ) );
		p.appendChild( _node('span'))
		 .appendChild( _txt( 

			t + (( USER !== n ) ? ' ' + n : '' )
		));

		_chatUpdate( p );

		return true;
	}


	/* print message to chat frame */

	function _chatUpdate( p ) {

		if (!p) return false;

		chat.content.appendChild( p );

		_chatResize();

		return true;
	}


	function _chatResize () {

		chat.scrollTop = chat.offsetHeight;

		chat.style.paddingTop = (iframe.offsetHeight - chat.content.offsetHeight) + 'px';
	}


	window.onresize = function() {

		_chatResize();

	}





/* ========================================== */

	/* system log */

	function _log( m ) {

		if(!m) return false;

		SYSLOG = SYSLOG || _body().appendChild( _node('textarea') );
		SYSLOG.className = 'log';
		SYSLOG.value = m + '\n' +  SYSLOG.value;
	}

/* ========================================== */


</script>

</body></html>